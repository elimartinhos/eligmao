<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { background: black; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; color: white; user-select: none; font-family: sans-serif; overflow: hidden; }
        
        .room {
            width: 380px; height: 500px;
            background: #0a0a0a; border: 4px solid #222;
            border-radius: 15px; position: relative;
            display: flex; flex-direction: column; align-items: center;
            justify-content: space-around; padding: 20px; box-sizing: border-box;
        }

        .bulb-container { position: relative; width: 100px; height: 150px; display: flex; justify-content: center; }
        
        .bulb {
            width: 80px; height: 80px; background: #222;
            border-radius: 50%; position: absolute; top: 20px;
            transition: background 0.1s, box-shadow 0.1s;
            border: 2px solid #333; z-index: 3;
        }
        .bulb::after {
            content: ''; position: absolute; bottom: -25px; left: 25px;
            width: 30px; height: 25px; background: linear-gradient(90deg, #333, #666, #333);
            border-radius: 0 0 5px 5px;
        }

        .limit-circle {
            position: absolute; top: -10px;
            width: 140px; height: 140px;
            background: black; border-radius: 50%;
            z-index: 1;
        }

        #glow-effect {
            position: absolute; top: 60px;
            width: 0px; height: 0px;
            border-radius: 50%;
            z-index: 2;
            pointer-events: none;
        }

        .filament {
            position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%);
            width: 20px; height: 15px; border: 2px solid #333; border-radius: 50%;
        }

        .shards-container {
            position: absolute; width: 100%; height: 100%;
            pointer-events: none; z-index: 4; display: none;
        }
        .shard {
            position: absolute; background: rgba(255,255,255,0.8);
            width: 4px; height: 4px; clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
        }

        .controls { display: flex; flex-direction: column; gap: 30px; align-items: center; }
        
        .lever-btn {
            width: 100px; height: 100px; background: #331111;
            border: 5px solid #222; border-radius: 15px; cursor: pointer;
            box-shadow: 0 5px 0 #111, inset 0 0 10px #000; transition: 0.1s;
        }
        .lever-btn:active { transform: translateY(4px); box-shadow: 0 1px 0 #111, inset 0 0 15px #000; background: #551111; }

        .action-btn {
            width: 80px; height: 40px; background: #111133;
            border: 3px solid #222; border-radius: 5px; cursor: pointer;
            box-shadow: inset 0 0 8px #000; display: flex; align-items: center; justify-content: center;
        }
        .action-btn.ready { background: #1e90ff; box-shadow: 0 0 15px #1e90ff, inset 0 0 10px #000; border-color: #555; }

        .completed .room { filter: grayscale(1) opacity(0.5); pointer-events: none; }
        #check-mark { position: absolute; font-size: 15rem; color: #00ff00; display: none; z-index: 100; text-shadow: 0 0 30px rgba(0,255,0,0.5); }

        @keyframes shatterAnim {
            0% { transform: translate(0,0) rotate(0); opacity: 1; }
            100% { transform: translate(var(--tx), var(--ty)) rotate(360deg); opacity: 0; }
        }
        .exploding .shard { animation: shatterAnim 0.5s ease-out forwards; }
    </style>
</head>
<body>

<div id="check-mark">✓</div>

<div class="room">
    <div class="bulb-container">
        <div class="limit-circle"></div>
        <div id="glow-effect"></div>
        <div class="bulb" id="bulb"><div class="filament" id="filament"></div></div>
        <div class="shards-container" id="shards"></div>
    </div>

    <div class="controls">
        <div class="lever-btn" 
             onmousedown="startCharge()" 
             onmouseup="endCharge()" 
             onmouseleave="endCharge()"
             ontouchstart="startCharge()" 
             ontouchend="endCharge()"
             ontouchcancel="endCharge()"></div>
        <div class="action-btn" id="fire-btn" onclick="tryFire()"></div>
    </div>
</div>

<script>
    let startTime;
    let chargeTime = 0;
    let isCharging = false;
    let timerRef;
    const bulb = document.getElementById('bulb');
    const filament = document.getElementById('filament');
    const glow = document.getElementById('glow-effect');
    const fireBtn = document.getElementById('fire-btn');
    const shardsCont = document.getElementById('shards');

    for(let i=0; i<15; i++) {
        const s = document.createElement('div');
        s.className = 'shard';
        s.style.left = '50px'; s.style.top = '50px';
        s.style.setProperty('--tx', (Math.random() * 300 - 150) + 'px');
        s.style.setProperty('--ty', (Math.random() * 300 - 150) + 'px');
        shardsCont.appendChild(s);
    }

    function startCharge() {
        if (document.body.classList.contains('completed')) return;
        clearInterval(timerRef); // Garante que não há timer rodando
        startTime = Date.now();
        isCharging = true;
        shardsCont.style.display = 'none';
        shardsCont.classList.remove('exploding');
        bulb.style.display = 'block';
        if (navigator.vibrate) navigator.vibrate(20);

        timerRef = setInterval(() => {
            const elapsed = (Date.now() - startTime) / 1000;
            const size = (elapsed / 3) * 140;
            glow.style.width = size + 'px';
            glow.style.height = size + 'px';
            glow.style.top = (60 - size/2) + 'px';
            glow.style.background = `radial-gradient(circle, rgba(255,200,0,0.9) 0%, rgba(255,100,0,0.4) 100%)`;
            glow.style.boxShadow = `0 0 20px orange`;
            filament.style.borderColor = `rgba(255,255,100,${Math.min(elapsed/3, 1)})`;
        }, 30);
    }

    function endCharge() {
        if (!isCharging) return;
        clearInterval(timerRef);
        chargeTime = (Date.now() - startTime) / 1000;
        isCharging = false;
        fireBtn.classList.add('ready');
        if (navigator.vibrate) navigator.vibrate(10);
    }

    function tryFire() {
        if (!fireBtn.classList.contains('ready')) return;
        // Range levemente maior para facilitar o acerto (2.8s a 3.3s)
        if (chargeTime >= 2.8 && chargeTime <= 3.3) {
            success();
        } else if (chargeTime > 3.3) {
            explode();
        } else {
            fail();
        }
    }

    function success() {
        if (navigator.vibrate) navigator.vibrate(200);
        bulb.style.background = "radial-gradient(circle, #fff 0%, #ffcc00 100%)";
        bulb.style.boxShadow = "0 0 100px #ffcc00";
        glow.style.display = "none";
        setTimeout(() => {
            document.body.classList.add('completed');
            document.getElementById('check-mark').style.display = 'block';
            window.parent.postMessage('nextPuzzle', '*');
        }, 500);
    }

    function explode() {
        if (navigator.vibrate) navigator.vibrate([100, 50, 200]);
        bulb.style.display = 'none';
        glow.style.display = "none";
        shardsCont.style.display = 'block';
        shardsCont.classList.add('exploding');
        setTimeout(reset, 800);
    }

    function fail() {
        if (navigator.vibrate) navigator.vibrate([40, 40]);
        reset();
    }

    function reset() {
        chargeTime = 0;
        isCharging = false;
        clearInterval(timerRef);
        glow.style.display = "block";
        glow.style.width = "0"; glow.style.height = "0";
        fireBtn.classList.remove('ready');
        bulb.style.display = 'block';
        bulb.style.background = "#222";
        bulb.style.boxShadow = "none";
        filament.style.borderColor = "#333";
    }
</script>
</body>
</html>