<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { background: black; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; color: white; user-select: none; font-family: sans-serif; overflow: hidden; }
        .case { width: 380px; height: 600px; background: #1a1a1a; border: 4px solid #333; border-radius: 20px; display: flex; flex-direction: column; align-items: center; padding: 20px; position: relative; box-shadow: 0 20px 50px rgba(0,0,0,0.8); justify-content: center; }
        .table { width: 340px; height: 540px; background: radial-gradient(circle, #265a29, #153d17); border-radius: 12px; position: relative; border: 15px solid #4a3028; box-sizing: border-box; }
        .pocket { width: 38px; height: 38px; background: #000; border-radius: 50%; position: absolute; z-index: 1; box-shadow: inset 0 0 10px #000; }
        .p-tl { top: -16px; left: -16px; } .p-tc { top: -18px; left: 50%; transform: translateX(-50%); } .p-tr { top: -16px; right: -16px; }
        .p-bl { bottom: -16px; left: -16px; } .p-bc { bottom: -18px; left: 50%; transform: translateX(-50%); } .p-br { bottom: -16px; right: -16px; }
        .ball { width: 20px; height: 20px; border-radius: 50%; position: absolute; z-index: 2; box-shadow: inset -2px -2px 5px rgba(0,0,0,0.5); }
        .white-ball { background: #fdfdfd; cursor: grab; z-index: 3; }
        .blue-ball { background: #2563eb; border: 1px solid #1e40af; box-shadow: 0 0 10px rgba(37,99,235,0.6); }
        .red-ball { background: #dc2626; border: 1px solid #991b1b; }
        #aim-line { position: absolute; pointer-events: none; stroke: rgba(255,255,255,0.2); stroke-width: 1.5; stroke-dasharray: 5,5; z-index: 4; }
        .completed .case { filter: grayscale(1) opacity(0.3); pointer-events: none; }
        #check-mark { position: absolute; font-size: 15rem; color: #00ff00; display: none; z-index: 100; text-shadow: 0 0 30px rgba(0,255,0,0.5); }
    </style>
</head>
<body>
<div id="check-mark">✓</div>
<div class="case">
    <div class="table" id="table">
        <div class="pocket p-tl"></div><div class="pocket p-tc"></div><div class="pocket p-tr"></div>
        <div class="pocket p-bl"></div><div class="pocket p-bc"></div><div class="pocket p-br"></div>
        <svg style="position:absolute; width:100%; height:100%; top:0; left:0; pointer-events:none;"><line id="aim-line" style="display:none"/></svg>
    </div>
</div>

<script>
    const table = document.getElementById('table');
    const line = document.getElementById('aim-line');
    const friction = 0.99; 
    const subSteps = 10; 

    let balls = [];
    let isDragging = false, shotTaken = false, isAnimating = false;

    class Ball {
        constructor(x, y, type) {
            this.x = x; this.y = y; this.vx = 0; this.vy = 0;
            this.type = type; 
            this.sunk = false;
            this.el = document.createElement('div');
            this.el.className = `ball ${type}-ball`;
            table.appendChild(this.el);
            this.updatePos();
        }
        updatePos() {
            this.el.style.transform = `translate(${this.x}px, ${this.y}px)`;
            if (this.sunk) this.el.style.display = 'none';
        }
    }

    function init() {
        balls = [];
        balls.push(new Ball(145, 450, 'white')); 
        balls.push(new Ball(20, 20, 'blue'));
        const redPositions = [[50, 100], [145, 180], [250, 50], [80, 280], [220, 300], [145, 30]];
        redPositions.forEach(p => balls.push(new Ball(p[0], p[1], 'red')));
    }

    init();

    window.addEventListener('pointerdown', (e) => {
        if (shotTaken) return;
        const rect = table.getBoundingClientRect();
        const dist = Math.hypot((e.clientX - rect.left - 15) - balls[0].x - 10, (e.clientY - rect.top - 15) - balls[0].y - 10);
        if (dist < 40) isDragging = true;
    });

    window.addEventListener('pointermove', (e) => {
        if (!isDragging) return;
        const rect = table.getBoundingClientRect();
        let mx = e.clientX - rect.left - 15, my = e.clientY - rect.top - 15;
        line.style.display = 'block';
        line.setAttribute('x1', balls[0].x + 10); line.setAttribute('y1', balls[0].y + 10);
        line.setAttribute('x2', balls[0].x + 10 + (balls[0].x + 10 - mx) * 2.5);
        line.setAttribute('y2', balls[0].y + 10 + (balls[0].y + 10 - my) * 2.5);
    });

    window.addEventListener('pointerup', (e) => {
        if (!isDragging) return;
        isDragging = false; line.style.display = 'none';
        const rect = table.getBoundingClientRect();
        balls[0].vx = (balls[0].x + 10 - (e.clientX - rect.left - 15)) * 0.16;
        balls[0].vy = (balls[0].y + 10 - (e.clientY - rect.top - 15)) * 0.16;
        shotTaken = true; isAnimating = true; animate();
    });

    function animate() {
        let moving = false;
        for (let s = 0; s < subSteps; s++) {
            balls.forEach(b => {
                if (b.sunk) return;
                b.x += b.vx / subSteps; b.y += b.vy / subSteps;
                if (b.x < 0 || b.x > 290) { b.vx *= -0.8; b.x = b.x < 0 ? 0 : 290; }
                if (b.y < 0 || b.y > 490) { b.vy *= -0.8; b.y = b.y < 0 ? 0 : 490; }
                
                const pks = [[0,0],[145,0],[290,0],[0,490],[145,490],[290,490]];
                pks.forEach(p => {
                    if (Math.hypot(b.x+10 - (p[0]+5), b.y+10 - (p[1]+5)) < 24) {
                        if (b.type === 'blue') {
                            b.sunk = true; success();
                        } else {
                            b.sunk = true; setTimeout(() => location.reload(), 500);
                        }
                    }
                });
            });

            for (let i = 0; i < balls.length; i++) {
                for (let j = i + 1; j < balls.length; j++) {
                    let b1 = balls[i], b2 = balls[j];
                    if (b1.sunk || b2.sunk) continue;
                    let dx = b2.x - b1.x, dy = b2.y - b1.y, dist = Math.hypot(dx, dy);
                    if (dist < 20) {
                        let nx = dx/dist, ny = dy/dist;
                        let overlap = 20 - dist;
                        b1.x -= nx * overlap/2; b1.y -= ny * overlap/2;
                        b2.x += nx * overlap/2; b2.y += ny * overlap/2;
                        let p = (b1.vx * nx + b1.vy * ny) - (b2.vx * nx + b2.vy * ny);
                        b1.vx -= p * nx; b1.vy -= p * ny;
                        b2.vx += p * nx; b2.vy += p * ny;
                    }
                }
            }
        }

        balls.forEach(b => {
            b.vx *= friction; b.vy *= friction;
            b.updatePos();
            if (Math.abs(b.vx) > 0.1 || Math.abs(b.vy) > 0.1) moving = true;
        });

        if (moving) {
            requestAnimationFrame(animate);
        } else if (isAnimating) {
            isAnimating = false;
            // Se parou e a azul não caiu, reinicia (uma tacada só)
            setTimeout(() => { if(!document.body.classList.contains('completed')) location.reload(); }, 500);
        }
    }

    function success() {
        document.body.classList.add('completed');
        document.getElementById('check-mark').style.display = 'block';
        setTimeout(() => window.parent.postMessage('nextPuzzle', '*'), 1500);
    }
</script>
</body>
</html>