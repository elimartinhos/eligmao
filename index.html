<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ELIGMAO</title>
    <style>
        body { background: black; margin: 0; height: 100vh; display: flex; flex-direction: column; font-family: sans-serif; overflow: hidden; color: white; }
        #game-header { width: 100%; padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; box-sizing: border-box; position: fixed; top: 0; z-index: 1000; background: rgba(0,0,0,0.9); border-bottom: 1px solid #222; }
        #puzzle-id { color: white; font-size: 24px; font-weight: bold; width: 80px; }
        #top-player { color: #aaa; font-size: 14px; text-align: center; flex-grow: 1; text-transform: uppercase; }
        #top-player span { color: #0f0; font-weight: bold; }
        #user-info { color: #0f0; font-size: 16px; font-weight: bold; width: 150px; text-align: right; }
        #login-screen { position: fixed; inset: 0; background: #000; z-index: 2000; display: flex; justify-content: center; align-items: center; }
        .login-box { background: #1a1a1a; padding: 40px; border-radius: 20px; border: 1px solid #333; text-align: center; width: 280px; }
        input { padding: 12px; width: 100%; border-radius: 8px; border: 1px solid #444; background: #222; color: white; margin-bottom: 10px; font-size: 16px; outline: none; text-align: center; box-sizing: border-box; }
        button { padding: 12px 30px; background: #0f0; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; color: black; width: 100%; margin-top: 10px; }
        button:disabled { background: #333; color: #777; }
        #scale-container { flex: 1; display: flex; justify-content: center; align-items: center; transform: scale(0.85); margin-top: 60px; }
        #wrapper { width: 380px; height: 620px; }
        #puzzle-frame { width: 100%; height: 100%; border: none; background: #1a1a1a; border-radius: 20px; }
    </style>
</head>
<body>

<div id="login-screen">
    <div class="login-box">
        <h2 style="margin-top:0">ELIGMAO</h2>
        <input type="text" id="username-input" placeholder="Usuário" maxlength="12">
        <input type="password" id="password-input" placeholder="Senha">
        <button id="login-btn" onclick="login()">ACESSAR / CRIAR</button>
    </div>
</div>

<div id="game-header">
    <div id="puzzle-id">#1</div>
    <div id="top-player">CARREGANDO...</div>
    <div id="user-info">---</div>
</div>

<div id="scale-container">
    <div id="wrapper"><iframe id="puzzle-frame" src="about:blank"></iframe></div>
</div>

<script>
    let user = "";
    let level = 1;

    async function hashPassword(string) {
        const utf8 = new TextEncoder().encode(string);
        const hashBuffer = await crypto.subtle.digest('SHA-256', utf8);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    async function callAPI(method, body = null) {
        const response = await fetch('/api/proxy', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ method, body })
        });
        return await response.json();
    }

    async function login() {
        const uInput = document.getElementById('username-input').value.trim();
        const pInput = document.getElementById('password-input').value.trim();
        
        if (!uInput || !pInput) {
            alert("Preencha usuário e senha!");
            return;
        }

        const btn = document.getElementById('login-btn');
        btn.disabled = true;
        btn.innerText = "VERIFICANDO...";

        user = uInput;
        const hashedPass = await hashPassword(pInput);
        
        await syncData(true, hashedPass);
    }

    async function syncData(isInitial = false, providedPass = null) {
        try {
            const data = await callAPI('GET');
            const content = JSON.parse(atob(data.content));
            
            if (content.players[user]) {
                const userData = content.players[user];
                if (isInitial) {
                    if (userData.pass !== providedPass) {
                        alert("Senha incorreta!");
                        document.getElementById('login-btn').disabled = false;
                        document.getElementById('login-btn').innerText = "ACESSAR / CRIAR";
                        return;
                    }
                }
                level = userData.level;
            } 
            else if (isInitial) {
                level = 1;
                content.players[user] = { level: 1, pass: providedPass };
                await callAPI('PUT', {
                    message: `Novo user: ${user}`,
                    content: btoa(JSON.stringify(content, null, 2)),
                    sha: data.sha
                });
            }

            // LÓGICA DO LÍDER CORRIGIDA
            let leader = { name: "---", lvl: 0 };
            for (let p in content.players) {
                if (content.players[p].level > leader.lvl) {
                    leader = { name: p, lvl: content.players[p].level };
                }
            }

            document.getElementById('puzzle-id').innerText = `#${level}`;
            document.getElementById('user-info').innerText = user.toUpperCase();
            document.getElementById('top-player').innerHTML = `LÍDER: <span>${leader.name}</span> (LVL ${leader.lvl})`;
            
            if (isInitial) {
                localStorage.setItem('p_user', user);
                localStorage.setItem('p_hash', providedPass);
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('puzzle-frame').src = `puzzle${level}.html`;
            }
        } catch (e) {
            console.error(e);
            alert("Erro na conexão.");
            document.getElementById('login-btn').disabled = false;
        }
    }

    window.addEventListener('message', async (e) => {
        if (e.data === 'nextPuzzle') {
            level++;
            const data = await callAPI('GET');
            const content = JSON.parse(atob(data.content));
            content.players[user].level = level;
            await callAPI('PUT', {
                message: `Update ${user} -> Lvl ${level}`,
                content: btoa(JSON.stringify(content, null, 2)),
                sha: data.sha
            });
            syncData(); // Recarrega ranking e líder
            document.getElementById('puzzle-frame').src = `puzzle${level}.html`;
        }
    });

    window.onload = async () => {
        const savedUser = localStorage.getItem('p_user');
        const savedHash = localStorage.getItem('p_hash');
        if(savedUser && savedHash) {
            user = savedUser;
            await syncData(true, savedHash);
        }
    }
</script>
</body>
</html>