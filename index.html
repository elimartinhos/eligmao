<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ELIGMAO - Online</title>
    <style>
        body { background: black; margin: 0; height: 100vh; display: flex; flex-direction: column; font-family: sans-serif; overflow: hidden; color: white; }
        
        #game-header { 
            width: 100%; padding: 15px 25px; display: flex; justify-content: space-between; 
            align-items: center; box-sizing: border-box; position: fixed; top: 0; z-index: 1000; 
        }
        
        #puzzle-id { color: white; font-size: 24px; font-weight: bold; width: 80px; }
        #top-player { color: #aaa; font-size: 14px; text-align: center; flex-grow: 1; text-transform: uppercase; }
        #top-player span { color: #0f0; font-weight: bold; }
        #user-info { color: #0f0; font-size: 16px; font-weight: bold; width: 150px; text-align: right; }

        #login-screen { position: fixed; inset: 0; background: #000; z-index: 2000; display: flex; justify-content: center; align-items: center; }
        .login-box { background: #1a1a1a; padding: 40px; border-radius: 20px; border: 1px solid #333; text-align: center; }
        input { padding: 12px; width: 220px; border-radius: 8px; border: 1px solid #444; background: #222; color: white; margin-bottom: 20px; font-size: 16px; outline: none; text-align: center; }
        button { padding: 12px 30px; background: #0f0; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; color: black; }
        button:disabled { background: #555; cursor: not-allowed; }

        #scale-container { flex: 1; display: flex; justify-content: center; align-items: center; transform: scale(0.85); margin-top: 50px; }
        #wrapper { width: 380px; height: 620px; }
        #puzzle-frame { width: 100%; height: 100%; border: none; background: #1a1a1a; border-radius: 20px; }
        
        #admin-panel { position: fixed; bottom: 20px; left: 20px; background: red; padding: 10px; border-radius: 5px; display: none; z-index: 10000; }
    </style>
</head>
<body>

<div id="login-screen">
    <div class="login-box">
        <h2 style="margin-top:0">ENTRAR / CRIAR</h2>
        <input type="text" id="username-input" placeholder="Usuário (máx 12)" maxlength="12">
        <br>
        <button id="login-btn" onclick="login()">ACESSAR</button>
    </div>
</div>

<div id="game-header">
    <div id="puzzle-id">#1</div>
    <div id="top-player">SINCRONIZANDO...</div>
    <div id="user-info">---</div>
</div>

<div id="admin-panel">
    ADMIN: <button onclick="skip()" style="cursor:pointer">SKIP</button>
</div>

<div id="scale-container">
    <div id="wrapper"><iframe id="puzzle-frame" src="about:blank"></iframe></div>
</div>

<script>
    const REPO_OWNER = "elimartinhos";
    const REPO_NAME = "eligmao";
    const FILE_PATH = "data.json";

    // Pega o token injetado pelo Vercel. 
    // Nota: Se rodar localmente, você pode colar o token aqui para testar.
    const GITHUB_TOKEN = "ghp_seu_token_aqui_ou_deixe_vazio_para_o_vercel_injetar";

    let user = "";
    let level = 1;

    async function login() {
        const input = document.getElementById('username-input').value.trim();
        if (!input) return;

        const btn = document.getElementById('login-btn');
        btn.disabled = true;
        btn.innerText = "CONECTANDO...";

        user = input;
        localStorage.setItem('p_user', user);
        
        if(user.toLowerCase() === 'admin') document.getElementById('admin-panel').style.display = 'block';
        
        await syncData(true);
    }

    async function syncData(isInitial = false) {
        // Fallback para caso a variável do Vercel não tenha sido injetada corretamente no build
        const token = (GITHUB_TOKEN.startsWith("ghp_")) ? GITHUB_TOKEN : ""; 
        
        if (!token) {
            console.error("Token ausente.");
            // Se falhar, tentamos prosseguir apenas localmente para não travar o usuário
            document.getElementById('top-player').innerText = "MODO OFFLINE (SEM TOKEN)";
            if (isInitial) {
                document.getElementById('login-screen').style.display = 'none';
                loadPuzzle();
            }
            return;
        }

        try {
            const res = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}`, {
                headers: { "Authorization": `token ${token}`, "Cache-Control": "no-cache" }
            });
            const data = await res.json();
            const content = JSON.parse(atob(data.content));
            
            // Se o usuário não existe, ele começa no 1
            level = content.players[user] || 1;

            // Se for novo login, já registra no GitHub
            if (isInitial && !content.players[user]) {
                await saveToGithub(content, data.sha);
            }

            updateUI(content);
            
            if (isInitial) {
                document.getElementById('login-screen').style.display = 'none';
                loadPuzzle();
            }
        } catch (e) {
            console.error("Erro na API:", e);
            btnReset();
        }
    }

    function updateUI(content) {
        let leader = { name: "---", lvl: 0 };
        for (let p in content.players) {
            if (content.players[p] > leader.lvl) leader = { name: p, lvl: content.players[p] };
        }
        document.getElementById('top-player').innerHTML = `LÍDER: <span>${leader.name}</span> (LVL ${leader.lvl})`;
        document.getElementById('puzzle-id').innerText = `#${level}`;
        document.getElementById('user-info').innerText = user.toUpperCase();
    }

    async function saveToGithub(existingContent = null, oldSha = null) {
        const token = (GITHUB_TOKEN.startsWith("ghp_")) ? GITHUB_TOKEN : "";
        if(!token) return;

        let currentContent = existingContent;
        let sha = oldSha;

        if (!currentContent || !sha) {
            const res = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}`, {
                headers: { "Authorization": `token ${token}`, "Cache-Control": "no-cache" }
            });
            const data = await res.json();
            currentContent = JSON.parse(atob(data.content));
            sha = data.sha;
        }

        currentContent.players[user] = level;

        await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}`, {
            method: "PUT",
            headers: { "Authorization": `token ${token}`, "Content-Type": "application/json" },
            body: JSON.stringify({
                message: `Update ${user} -> ${level}`,
                content: btoa(JSON.stringify(currentContent, null, 2)),
                sha: sha
            })
        });
    }

    function loadPuzzle() {
        document.getElementById('puzzle-frame').src = `puzzle${level}.html`;
    }

    function btnReset() {
        const btn = document.getElementById('login-btn');
        btn.disabled = false;
        btn.innerText = "ACESSAR";
    }

    window.addEventListener('message', async (e) => {
        if (e.data === 'nextPuzzle') {
            level++;
            await saveToGithub();
            syncData();
            loadPuzzle();
        }
    });

    function skip() {
        level++;
        saveToGithub().then(() => {
            syncData();
            loadPuzzle();
        });
    }

    window.onload = () => {
        const saved = localStorage.getItem('p_user');
        if(saved) {
            document.getElementById('username-input').value = saved;
            login();
        }
    }
</script>
</body>
</html>